<!DOCTYPE html>
<html lang="pt-BR" data-theme="default">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Rotina Semanal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <meta name="theme-color" content="#4f46e5">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <style>
        :root {
            --bg-primary: 241 245 249; /* slate-100 */
            --bg-secondary: 255 255 255; /* white */
            --bg-header: 79 70 229; /* indigo-600 */
            --text-primary: 30 41 59; /* slate-800 */
            --text-secondary: 100 116 139; /* slate-500 */
            --text-on-header: 255 255 255; /* white */
            --accent: 79 70 229; /* indigo-600 */
        }
        html[data-theme="dark"] {
            --bg-primary: 15 23 42; --bg-secondary: 30 41 59; --bg-header: 67 56 202; --text-primary: 226 232 240; --text-secondary: 148 163 184; --text-on-header: 255 255 255; --accent: 99 102 241;
        }
        html[data-theme="ocean"] {
            --bg-primary: 240 253 250; --bg-secondary: 255 255 255; --bg-header: 15 118 110; --text-primary: 20 83 45; --text-secondary: 64 121 95; --text-on-header: 255 255 255; --accent: 20 184 166;
        }
        html[data-theme="dark_ocean"] {
            --bg-primary: 20 32 44; --bg-secondary: 29 45 59; --bg-header: 4 75 84; --text-primary: 187 247 208; --text-secondary: 107 165 148; --text-on-header: 255 255 255; --accent: 45 212 191;
        }
        html[data-theme="forest"] {
            --bg-primary: 254 252 232; --bg-secondary: 255 255 255; --bg-header: 101 163 13; --text-primary: 68 64 60; --text-secondary: 120 113 108; --text-on-header: 255 255 255; --accent: 132 204 22;
        }
        html[data-theme="dark_forest"] {
            --bg-primary: 28 25 23; --bg-secondary: 41 37 36; --bg-header: 64 64 32; --text-primary: 214 211 209; --text-secondary: 168 162 158; --text-on-header: 255 255 255; --accent: 163 230 53;
        }

        body { font-family: 'Inter', sans-serif; background-color: rgb(var(--bg-primary)); color: rgb(var(--text-primary)); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .task-container.completed .task-text { text-decoration: line-through; opacity: 0.6; }
        .task-container.completed .checkbox-custom { background-color: rgb(var(--accent)); border-color: rgb(var(--accent)); }
        .task-container.completed .checkbox-custom svg { transform: scale(1); }
        .checkbox-custom svg { transform: scale(0); transition: transform 0.2s ease; }

        .task-highlighted { box-shadow: 0 0 0 2px #f59e0b inset; }
        .star-icon.highlighted svg { fill: #f59e0b; stroke: #f59e0b; }

        #app-container.view-compact .task-slot { min-height: 48px; }
        #app-container.view-compact .task-container { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        #app-container.view-compact time { display: none; }
        
        #app-container.focus-mode .past-day, #app-container.focus-mode .completed { display: none; }

        .transition-smooth { transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1); }
        
        .modal-container { transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; opacity: 0; transform: scale(0.95); }
        .modal-container.open { opacity: 1; transform: scale(1); }
        .modal-backdrop { backdrop-filter: blur(4px); }
        
        [data-category="study"] { border-left-color: #3b82f6; }
        [data-category="work"] { border-left-color: #22c55e; }
        [data-category="leisure"] { border-left-color: #a855f7; }
        [data-category="personal"] { border-left-color: #ec4899; }
        [data-category="health"] { border-left-color: #f59e0b; }
        [data-category="finance"] { border-left-color: #64748b; }
        [data-category="home"] { border-left-color: #a16207; }
        [data-category="social"] { border-left-color: #db2777; }
        .task-container { border-left-width: 4px; border-left-color: transparent; }

        .past-day { opacity: 0.5; filter: grayscale(40%); }
        .task-container.dragging { opacity: 0.5; }
        .drag-over { background-color: rgba(var(--accent), 0.1); }
    </style>
</head>
<body>

    <div id="app-container" class="flex flex-col h-screen">
        <!-- Cabeçalho -->
        <header class="bg-[rgb(var(--bg-header))] text-[rgb(var(--text-on-header))] p-4 shadow-md z-20 flex-shrink-0">
            <div class="flex justify-between items-center">
                <h1 id="header-title" class="text-xl font-bold tracking-tight">Minha Rotina</h1>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <button id="focus-mode-toggle" title="Modo Foco" class="flex flex-col items-center p-1 rounded-md hover:bg-black/20 transition-smooth"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg><span class="text-xs hidden sm:block">Foco</span></button>
                    <button id="reports-btn" title="Relatórios" class="flex flex-col items-center p-1 rounded-md hover:bg-black/20 transition-smooth"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg><span class="text-xs hidden sm:block">Relatórios</span></button>
                    <button id="compact-view-toggle" title="Visão Compacta" class="flex flex-col items-center p-1 rounded-md hover:bg-black/20 transition-smooth"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg><span class="text-xs hidden sm:block">Compacta</span></button>
                    <button id="settings-btn" title="Configurações" class="flex flex-col items-center p-1 rounded-md hover:bg-black/20 transition-smooth"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg><span class="text-xs hidden sm:block">Ajustes</span></button>
                    <button id="toggle-view-btn" class="flex flex-col items-center p-1 rounded-md bg-black/10 hover:bg-black/20 font-semibold text-sm transition-smooth"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span class="text-xs hidden sm:block">Mês</span></button>
                </div>
            </div>
            <div id="nav-controls" class="flex justify-between items-center mt-3">
                <button id="prev-btn" class="p-2 rounded-full hover:bg-black/20 transition-smooth">&lt;</button>
                <p id="current-period" class="text-sm font-medium text-center"></p>
                <button id="next-btn" class="p-2 rounded-full hover:bg-black/20 transition-smooth">&gt;</button>
            </div>
            <div id="header-goal-progress" class="mt-3 space-y-2"></div>
        </header>

        <main class="flex-1 overflow-hidden relative">
            <div id="weekly-view" class="flex h-full overflow-x-auto bg-[rgb(var(--bg-secondary))]"></div>
            <div id="monthly-view" class="hidden h-full overflow-y-auto bg-[rgb(var(--bg-secondary))] p-2 sm:p-4"></div>
        </main>

        <footer id="upcoming-events-footer" class="flex-shrink-0 bg-[rgb(var(--bg-secondary))] border-t border-slate-200 dark:border-slate-700 p-3 h-48"></footer>
    </div>

    <!-- Modais -->
    <div id="task-modal" class="hidden fixed inset-0 bg-black/30 z-30 flex items-center justify-center p-4 modal-backdrop">
        <div id="task-modal-container" class="modal-container bg-[rgb(var(--bg-secondary))] rounded-lg shadow-xl w-full max-w-md overflow-hidden">
            <div class="p-6 bg-slate-50 dark:bg-slate-900/50 border-b border-slate-200 dark:border-slate-700"><h3 class="font-bold text-xl">Editar Tarefa</h3></div>
            <div class="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                <div class="relative"><span id="modal-icon-display" class="absolute top-2.5 left-3 text-xl opacity-50"></span><textarea id="modal-textarea" class="w-full h-24 p-2 pl-10 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent focus:outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]" placeholder="Descreva sua tarefa..."></textarea></div>
                <div><label class="font-semibold text-sm text-[rgb(var(--text-secondary))]">Notas</label><textarea id="modal-notes" class="mt-1 w-full h-20 p-2 border border-slate-300 dark:border-slate-600 rounded-md bg-transparent focus:outline-none focus:ring-2 focus:ring-[rgb(var(--accent))]" placeholder="Adicione detalhes..."></textarea></div>
                <div><label class="font-semibold text-sm text-[rgb(var(--text-secondary))]">Sub-tarefas</label><div id="modal-subtasks" class="mt-2 space-y-2"></div><button id="add-subtask-btn" class="mt-2 text-sm text-[rgb(var(--accent))] font-semibold">+ Adicionar sub-tarefa</button></div>
                <div><label class="font-semibold text-sm text-[rgb(var(--text-secondary))]">Categoria</label><div id="modal-categories" class="flex flex-wrap gap-2 mt-2"></div></div>
                <div><label class="font-semibold text-sm text-[rgb(var(--text-secondary))]">Ícone</label><div id="modal-icons" class="flex flex-wrap gap-2 mt-2 text-xl"></div></div>
                <div>
                    <label for="modal-reminder" class="font-semibold text-sm text-[rgb(var(--text-secondary))]">Lembrete</label>
                    <select id="modal-reminder" class="w-full mt-1 p-2 rounded-md bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600 border">
                        <option value="none">Sem lembrete</option>
                        <option value="15">15 minutos antes</option>
                        <option value="30">30 minutos antes</option>
                        <option value="60">1 hora antes</option>
                    </select>
                </div>
                <div><label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="modal-recurring" class="rounded text-[rgb(var(--accent))] focus:ring-[rgb(var(--accent))]"><span class="text-sm">Repetir semanalmente</span></label></div>
            </div>
            <div class="p-6 bg-slate-50 dark:bg-slate-900/50 flex justify-between items-center">
                <button id="modal-delete" class="px-4 py-2 rounded-md text-sm font-semibold text-red-600 hover:bg-red-100 dark:hover:bg-red-900/30 transition-smooth">Excluir</button>
                <div class="flex space-x-3">
                    <button id="modal-cancel" class="px-4 py-2 rounded-md text-sm font-semibold text-[rgb(var(--text-primary))] bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 transition-smooth">Cancelar</button>
                    <button id="modal-save" class="px-4 py-2 rounded-md text-sm font-semibold bg-[rgb(var(--accent))] text-white hover:opacity-90 transition-smooth">Salvar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/30 z-30 flex items-center justify-center p-4 modal-backdrop">
        <div id="settings-modal-container" class="modal-container bg-[rgb(var(--bg-secondary))] rounded-lg shadow-xl w-full max-w-lg overflow-hidden">
            <div class="p-6"><h3 class="font-bold text-lg">Configurações</h3></div>
            <div class="p-6 space-y-6 max-h-[60vh] overflow-y-auto">
                <div>
                    <h4 class="font-semibold">Tema Visual</h4>
                    <select id="theme-selector" class="w-full mt-2 p-2 rounded-md bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600 border"><option value="default">Padrão</option><option value="dark">Escuro</option><option value="ocean">Oceano</option><option value="dark_ocean">Oceano Escuro</option><option value="forest">Floresta</option><option value="dark_forest">Floresta Escura</option></select>
                </div>
                <div>
                    <h4 class="font-semibold">Metas Semanais</h4>
                    <div id="goals-list" class="mt-3 space-y-3"></div>
                    <button id="add-goal-btn" class="mt-3 w-full px-4 py-2 text-sm rounded-md bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition-smooth">+ Adicionar Meta</button>
                </div>
                <div>
                    <h4 class="font-semibold">Aniversários</h4>
                    <div id="birthdays-list" class="mt-3 space-y-3"></div>
                    <button id="add-birthday-btn" class="mt-3 w-full px-4 py-2 text-sm rounded-md bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition-smooth">+ Adicionar Aniversário</button>
                </div>
                 <div>
                    <h4 class="font-semibold">Notificações</h4>
                     <button id="enable-notifications-btn" class="mt-2 px-4 py-2 text-sm rounded-md bg-green-600 text-white hover:bg-green-700 transition-smooth disabled:opacity-50 disabled:cursor-not-allowed">Ativar Lembretes</button>
                </div>
            </div>
            <div class="p-6 bg-slate-50 dark:bg-slate-900/50 flex justify-end">
                <button id="settings-close" class="px-4 py-2 rounded-md bg-[rgb(var(--accent))] text-white hover:opacity-90 transition-smooth">Fechar</button>
            </div>
        </div>
    </div>

    <div id="reports-modal" class="hidden fixed inset-0 bg-black/30 z-30 flex items-center justify-center p-4 modal-backdrop">
        <div id="reports-modal-container" class="modal-container bg-[rgb(var(--bg-secondary))] rounded-lg shadow-xl w-full max-w-2xl overflow-hidden">
            <div class="p-6"><h3 class="font-bold text-lg">Relatório da Semana</h3></div>
            <div id="reports-content" class="p-6 max-h-[60vh] overflow-y-auto"></div>
            <div class="p-6 bg-slate-50 dark:bg-slate-900/50 flex justify-end">
                <button id="reports-close" class="px-4 py-2 rounded-md bg-[rgb(var(--accent))] text-white hover:opacity-90 transition-smooth">Fechar</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const CATEGORIES = {
            study: { label: 'Estudo', color: '#3b82f6' },
            work: { label: 'Trabalho', color: '#22c55e' },
            health: { label: 'Saúde', color: '#f59e0b' },
            home: { label: 'Casa', color: '#a16207' },
            finance: { label: 'Finanças', color: '#64748b' },
            social: { label: 'Social', color: '#db2777' },
            leisure: { label: 'Lazer', color: '#a855f7' },
            personal: { label: 'Pessoal', color: '#ec4899' },
        };
        const ICONS = ['🎓', '💼', '🏋️', '🩺', '🏠', '💰', '👥', '🍽️', '❤️', '🧘', '✈️', '🛒', '🎉', '💡', '🧠', '📞'];
        const HOLIDAYS_BR_2025 = {
            '01-01': 'Confraternização Universal', '03-04': 'Carnaval', '04-18': 'Paixão de Cristo', '04-21': 'Tiradentes', '05-01': 'Dia do Trabalho', '06-19': 'Corpus Christi', '09-07': 'Independência do Brasil', '10-12': 'Nossa Senhora Aparecida', '11-02': 'Finados', '11-15': 'Proclamação da República', '12-25': 'Natal'
        };

        const elements = {
            appContainer: document.getElementById('app-container'), weeklyView: document.getElementById('weekly-view'), monthlyView: document.getElementById('monthly-view'), currentPeriodEl: document.getElementById('current-period'), prevBtn: document.getElementById('prev-btn'), nextBtn: document.getElementById('next-btn'), toggleViewBtn: document.getElementById('toggle-view-btn'), headerTitle: document.getElementById('header-title'), compactViewToggle: document.getElementById('compact-view-toggle'), headerGoalProgress: document.getElementById('header-goal-progress'), taskModal: document.getElementById('task-modal'), taskModalContainer: document.getElementById('task-modal-container'), modalTextarea: document.getElementById('modal-textarea'), modalNotes: document.getElementById('modal-notes'), modalSubtasks: document.getElementById('modal-subtasks'), addSubtaskBtn: document.getElementById('add-subtask-btn'), modalCategories: document.getElementById('modal-categories'), modalIcons: document.getElementById('modal-icons'), modalIconDisplay: document.getElementById('modal-icon-display'), modalRecurring: document.getElementById('modal-recurring'), modalReminder: document.getElementById('modal-reminder'), modalCancel: document.getElementById('modal-cancel'), modalSave: document.getElementById('modal-save'), modalDelete: document.getElementById('modal-delete'), settingsModal: document.getElementById('settings-modal'), settingsModalContainer: document.getElementById('settings-modal-container'), settingsBtn: document.getElementById('settings-btn'), settingsClose: document.getElementById('settings-close'), themeSelector: document.getElementById('theme-selector'), goalsList: document.getElementById('goals-list'), addGoalBtn: document.getElementById('add-goal-btn'), birthdaysList: document.getElementById('birthdays-list'), addBirthdayBtn: document.getElementById('add-birthday-btn'), upcomingEventsFooter: document.getElementById('upcoming-events-footer'), reportsModal: document.getElementById('reports-modal'), reportsModalContainer: document.getElementById('reports-modal-container'), reportsBtn: document.getElementById('reports-btn'), reportsClose: document.getElementById('reports-close'), reportsContent: document.getElementById('reports-content'), focusModeToggle: document.getElementById('focus-mode-toggle'), enableNotificationsBtn: document.getElementById('enable-notifications-btn'),
        };

        let state = {
            currentDate: new Date(), currentView: 'week', tasks: {}, settings: { compactView: false, focusMode: false, theme: 'default', goals: [{id: `goal_${Date.now()}`, category: 'study', hours: 5, enabled: true }], birthdays: [] }, activeModalKey: null, notificationInterval: null,
        };
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const loadData = () => {
            const savedTasks = localStorage.getItem('routineTasks');
            const savedSettings = localStorage.getItem('routineSettings');
            if (savedTasks) state.tasks = JSON.parse(savedTasks);
            if (savedSettings) {
                const loadedSettings = JSON.parse(savedSettings);
                if (!Array.isArray(loadedSettings.goals)) loadedSettings.goals = [{id: `goal_${Date.now()}`, category: 'study', hours: 5, enabled: true }];
                if (!Array.isArray(loadedSettings.birthdays)) loadedSettings.birthdays = [];
                state.settings = { ...state.settings, ...loadedSettings };
            }
            state.currentDate = new Date();
        };
        const saveData = () => {
            localStorage.setItem('routineTasks', JSON.stringify(state.tasks));
            localStorage.setItem('routineSettings', JSON.stringify(state.settings));
        };

        const getTaskKey = (date, hour) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}_${String(hour).padStart(2, '0')}:00`;
        const getTask = (key) => state.tasks[key] || {};
        const updateTask = (key, data) => {
            state.tasks[key] = { ...(state.tasks[key] || {}), ...data };
            if (!state.tasks[key].text && !state.tasks[key].notes && (!state.tasks[key].subtasks || state.tasks[key].subtasks.length === 0)) {
                delete state.tasks[key];
            }
            saveData();
            render();
        };
        const deleteTask = (key) => {
            delete state.tasks[key];
            saveData();
            render();
        };

        const render = () => {
            document.documentElement.setAttribute('data-theme', state.settings.theme);
            elements.appContainer.classList.toggle('view-compact', state.settings.compactView);
            elements.appContainer.classList.toggle('focus-mode', state.settings.focusMode);
            if (state.currentView === 'week') {
                renderWeek();
                elements.weeklyView.classList.remove('hidden');
                elements.monthlyView.classList.add('hidden');
            } else {
                renderMonth();
                elements.weeklyView.classList.add('hidden');
                elements.monthlyView.classList.remove('hidden');
            }
            renderHeaderGoalProgress();
            renderUpcomingEvents();
        };

        const renderWeek = () => {
            elements.weeklyView.innerHTML = '';
            const startOfWeek = new Date(state.currentDate);
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 6);
            elements.currentPeriodEl.textContent = `${startOfWeek.toLocaleDateString('pt-BR', {day: '2-digit', month: 'short'})} - ${endOfWeek.toLocaleDateString('pt-BR', {day: '2-digit', month: 'short'})}`;
            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(day.getDate() + i);
                elements.weeklyView.appendChild(createDayColumn(day));
            }
            setTimeout(() => {
                const todayColumn = elements.weeklyView.querySelector('.is-today');
                if (todayColumn) {
                    todayColumn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                }
            }, 100);
        };

        const createDayColumn = (date) => {
            const isToday = date.toDateString() === today.toDateString();
            const isPast = date < today && !isToday;
            const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            const dateKey = `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            const holiday = HOLIDAYS_BR_2025[dateKey];
            const birthdays = state.settings.birthdays.filter(b => b.date === dateKey && b.name);
            const column = document.createElement('div');
            column.className = `w-72 md:w-1/3 lg:w-1/7 flex-shrink-0 border-r border-slate-200 dark:border-slate-700 flex flex-col transition-opacity ${isToday ? 'is-today' : ''} ${isPast ? 'past-day' : ''}`;
            let eventsHTML = '';
            if (holiday || birthdays.length > 0) {
                eventsHTML += '<div class="px-2 py-1 border-b border-slate-200 dark:border-slate-700 text-xs space-y-1">';
                if (holiday) eventsHTML += `<div class="bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-200 p-1 rounded-md">🇧🇷 ${holiday}</div>`;
                birthdays.forEach(b => { eventsHTML += `<div class="bg-cyan-100 dark:bg-cyan-900/50 text-cyan-800 dark:text-cyan-200 p-1 rounded-md">🎂 ${b.name}</div>`; });
                eventsHTML += '</div>';
            }
            column.innerHTML = `
                <div class="p-3 text-center border-b border-slate-200 dark:border-slate-700 sticky top-0 z-10 bg-[rgb(var(--bg-secondary))] ${isToday ? 'bg-opacity-50' : ''}">
                    <p class="font-semibold text-[rgb(var(--text-secondary))]">${dayNames[date.getDay()]}</p>
                    <p class="text-2xl font-bold ${isToday ? 'text-[rgb(var(--accent))]' : ''}">${date.getDate()}</p>
                </div>
                ${eventsHTML}
                <div class="flex-1 overflow-y-auto no-scrollbar p-2 space-y-1">${Array.from({length: 17}, (_, i) => 7 + i).map(hour => createTimeSlot(date, hour)).join('')}</div>`;
            return column;
        };

        const createTimeSlot = (date, hour) => {
            const key = getTaskKey(date, hour);
            let task = getTask(key);
            const dayOfWeek = date.getDay();
            const recurringKey = `recurring_${dayOfWeek}_${String(hour).padStart(2, '0')}:00`;
            const recurringTask = getTask(recurringKey);
            if (recurringTask.recurring && !task.text) task = { ...recurringTask, recurring: false };
            return `<div class="task-slot flex items-start space-x-2 min-h-[64px]" data-key="${key}">
                    <time class="text-xs font-medium text-[rgb(var(--text-secondary))] mt-2 w-10 text-right">${String(hour).padStart(2, '0')}:00</time>
                    <div draggable="true" data-key="${key}" class="task-container flex-1 bg-slate-50 dark:bg-slate-700/50 p-2 rounded-lg shadow-sm flex items-start space-x-2 transition-smooth cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700 ${task.completed ? 'completed' : ''} ${task.highlighted ? 'task-highlighted' : ''}" data-category="${task.category || ''}">
                        <div class="checkbox-custom mt-1 w-4 h-4 border-2 border-slate-300 dark:border-slate-500 rounded-full flex items-center justify-center flex-shrink-0"><svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div>
                        <div class="flex-1"><p class="task-text text-sm">${task.icon || ''} ${task.text || ' '}</p></div>
                        <button class="star-icon p-1 rounded-full ${task.highlighted ? 'highlighted' : ''}"><svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg></button>
                    </div>
                </div>`;
        };
        
        const renderMonth = () => {
            elements.monthlyView.innerHTML = '';
            const year = state.currentDate.getFullYear();
            const month = state.currentDate.getMonth();
            elements.currentPeriodEl.textContent = state.currentDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const startDayOfWeek = firstDayOfMonth.getDay();
            let gridHTML = `<div class="grid grid-cols-7 gap-2 text-center text-sm font-semibold text-[rgb(var(--text-secondary))] border-b border-slate-200 dark:border-slate-700 pb-2 mb-2">${['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].map(d => `<div>${d}</div>`).join('')}</div><div class="grid grid-cols-7 gap-2">`;
            for (let i = 0; i < startDayOfWeek; i++) gridHTML += `<div></div>`;
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const isToday = date.toDateString() === today.toDateString();
                const isPast = date < today && !isToday;
                const highlightedTasks = Object.keys(state.tasks).filter(key => key.startsWith(getTaskKey(date, 0).substring(0, 10)) && state.tasks[key].highlighted && state.tasks[key].text);
                gridHTML += `<div class="border border-slate-200 dark:border-slate-700 rounded-lg p-2 min-h-[110px] flex flex-col transition-opacity hover:bg-slate-50 dark:hover:bg-slate-700/50 ${isPast ? 'past-day' : ''}"><span class="font-bold ${isToday ? 'text-[rgb(var(--accent))]' : ''}">${day}</span><ul class="text-xs text-left mt-1 space-y-1 overflow-y-auto no-scrollbar">${highlightedTasks.map(key => { const task = state.tasks[key]; return `<li class="bg-amber-100 dark:bg-amber-900/80 text-amber-800 dark:text-amber-200 p-1 rounded-md text-ellipsis overflow-hidden whitespace-nowrap">${task.icon || ''} ${task.text}</li>`; }).join('')}</ul></div>`;
            }
            gridHTML += '</div>';
            elements.monthlyView.innerHTML = gridHTML;
        };

        const renderHeaderGoalProgress = () => {
            elements.headerGoalProgress.innerHTML = '';
            if (!state.settings.goals) return;
            state.settings.goals.forEach(goal => {
                if (!goal.enabled) return;
                const { category, hours } = goal;
                const startOfWeek = new Date(state.currentDate);
                startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
                startOfWeek.setHours(0, 0, 0, 0);
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(endOfWeek.getDate() + 7);
                let hoursDone = 0;
                for (const key in state.tasks) {
                    const [dateStr] = key.split('_');
                    const taskDate = new Date(dateStr);
                    const task = state.tasks[key];
                    if (task.category === category && task.completed && taskDate >= startOfWeek && taskDate < endOfWeek) hoursDone++;
                }
                const progressPercentage = hours > 0 ? Math.min((hoursDone / hours) * 100, 100) : 0;
                elements.headerGoalProgress.innerHTML += `<div><div class="flex justify-between text-xs font-bold text-white/80 mb-1"><span>Meta: ${CATEGORIES[category]?.label || category}</span><span>${hoursDone}/${hours}h</span></div><div class="w-full bg-black/20 rounded-full h-1.5"><div class="bg-white rounded-full h-1.5" style="width: ${progressPercentage}%"></div></div></div>`;
            });
        };

        const renderUpcomingEvents = () => {
            const events = [];
            const currentYear = today.getFullYear();
            Object.entries(HOLIDAYS_BR_2025).forEach(([dateKey, name]) => {
                let eventDate = new Date(`${currentYear}-${dateKey}T12:00:00`);
                if (eventDate < today) eventDate.setFullYear(currentYear + 1);
                events.push({ date: eventDate, name: `🇧🇷 ${name}`, type: 'holiday'});
            });
            state.settings.birthdays.forEach(b => {
                if (!b.date || !b.name) return;
                let eventDate = new Date(`${currentYear}-${b.date}T12:00:00`);
                if (eventDate < today) eventDate.setFullYear(currentYear + 1);
                events.push({ date: eventDate, name: `🎂 ${b.name}`, type: 'birthday'});
            });
            const upcomingEvents = events.sort((a, b) => a.date - b.date).slice(0, 7);
            if (upcomingEvents.length === 0) {
                elements.upcomingEventsFooter.innerHTML = `<h4 class="font-semibold text-sm mb-2">Próximos Eventos</h4><p class="text-sm text-[rgb(var(--text-secondary))]">Nenhum evento cadastrado.</p>`;
                return;
            }
            elements.upcomingEventsFooter.innerHTML = `<h4 class="font-semibold text-sm mb-2">Próximos Eventos</h4><div class="space-y-2 overflow-y-auto no-scrollbar h-full">${upcomingEvents.map(event => {
                const bgColor = event.type === 'birthday' ? 'bg-cyan-100 dark:bg-cyan-700/50 text-cyan-800 dark:text-cyan-200' : 'bg-green-100 dark:bg-green-700/50 text-green-800 dark:text-green-200';
                const fullDateFormatter = new Intl.DateTimeFormat('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
                return `<div class="flex items-center space-x-3 text-sm"><div class="font-bold text-center w-16 p-1 rounded-md ${bgColor}"><span class="block text-xs uppercase">${event.date.toLocaleDateString('pt-BR', { month: 'short'})}</span><span class="block text-lg leading-tight">${event.date.getDate()}</span></div><div><p class="font-semibold">${event.name}</p><p class="text-xs text-[rgb(var(--text-secondary))]">${fullDateFormatter.format(event.date)}</p></div></div>`
            }).join('')}</div>`;
        };

        const renderGoalsInSettings = () => {
            elements.goalsList.innerHTML = '';
            if (!state.settings.goals) state.settings.goals = [];
            state.settings.goals.forEach(goal => {
                const goalEl = document.createElement('div');
                goalEl.className = 'p-3 border rounded-md border-slate-200 dark:border-slate-700';
                goalEl.innerHTML = `<div class="flex items-center justify-between"><div class="flex items-center space-x-2"><select data-id="${goal.id}" class="goal-category-select p-2 rounded-md bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600 border"></select><span>por</span><input data-id="${goal.id}" type="number" class="goal-hours-input w-20 p-2 rounded-md bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600 border" min="1" value="${goal.hours}"><span>horas.</span></div><button data-id="${goal.id}" class="delete-goal-btn p-2 text-red-500 hover:bg-red-100 dark:hover:bg-red-900/50 rounded-full">&times;</button></div>`;
                const selectEl = goalEl.querySelector('.goal-category-select');
                selectEl.innerHTML = Object.keys(CATEGORIES).map(key => `<option value="${key}" ${goal.category === key ? 'selected' : ''}>${CATEGORIES[key].label}</option>`).join('');
                elements.goalsList.appendChild(goalEl);
            });
        };

        const renderBirthdaysInSettings = () => {
            elements.birthdaysList.innerHTML = '';
            if (!state.settings.birthdays) state.settings.birthdays = [];
            state.settings.birthdays.forEach(b => {
                const bEl = document.createElement('div');
                bEl.className = 'flex items-center justify-between p-2 border rounded-md border-slate-200 dark:border-slate-700';
                bEl.innerHTML = `<div class="flex items-center space-x-2"><input data-id="${b.id}" type="text" class="birthday-name-input p-2 rounded-md bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600 border flex-1" placeholder="Nome" value="${b.name}"><input data-id="${b.id}" type="text" class="birthday-date-input w-24 p-2 rounded-md bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600 border" placeholder="MM-DD" value="${b.date}"></div><button data-id="${b.id}" class="delete-birthday-btn p-2 text-red-500 hover:bg-red-100 dark:hover:bg-red-900/50 rounded-full">&times;</button>`;
                elements.birthdaysList.appendChild(bEl);
            });
        };
        
        const renderReports = () => {
            const categoryHours = {};
            const startOfWeek = new Date(state.currentDate);
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
            startOfWeek.setHours(0, 0, 0, 0);
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 7);
            
            for (const key in state.tasks) {
                const [dateStr] = key.split('_');
                const taskDate = new Date(dateStr);
                const task = state.tasks[key];
                if (task.category && taskDate >= startOfWeek && taskDate < endOfWeek) {
                    categoryHours[task.category] = (categoryHours[task.category] || 0) + 1;
                }
            }

            if (Object.keys(categoryHours).length === 0) {
                elements.reportsContent.innerHTML = `<p class="text-[rgb(var(--text-secondary))]">Nenhuma tarefa categorizada esta semana para exibir no relatório.</p>`;
                return;
            }

            const maxHours = Math.max(...Object.values(categoryHours));
            elements.reportsContent.innerHTML = `
                <div class="space-y-4">
                    ${Object.entries(categoryHours).map(([cat, hours]) => `
                        <div class="grid grid-cols-4 items-center gap-4">
                            <span class="font-semibold col-span-1">${CATEGORIES[cat]?.label || cat}</span>
                            <div class="col-span-3 bg-slate-200 dark:bg-slate-700 rounded-full">
                                <div class="bg-[${CATEGORIES[cat]?.color || '#888'}] text-xs font-medium text-blue-100 text-center p-1 leading-none rounded-full" style="width: ${(hours/maxHours)*100}%">
                                    ${hours}h
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>`;
        };

        const openModal = (modalEl, containerEl) => {
            modalEl.classList.remove('hidden');
            setTimeout(() => containerEl.classList.add('open'), 10);
        };
        const closeModal = (modalEl, containerEl) => {
            containerEl.classList.remove('open');
            setTimeout(() => modalEl.classList.add('hidden'), 200);
        };

        const openTaskModal = (key) => {
            state.activeModalKey = key;
            const task = getTask(key);
            elements.modalTextarea.value = task.text || '';
            elements.modalNotes.value = task.notes || '';
            elements.modalIconDisplay.textContent = task.icon || '';
            elements.modalReminder.value = task.reminder || 'none';
            
            elements.modalSubtasks.innerHTML = '';
            if (task.subtasks) {
                task.subtasks.forEach(subtask => {
                    const subtaskEl = document.createElement('div');
                    subtaskEl.className = 'flex items-center space-x-2';
                    subtaskEl.innerHTML = `<input type="checkbox" class="subtask-checkbox rounded text-[rgb(var(--accent))]" ${subtask.completed ? 'checked' : ''}><input type="text" class="subtask-text flex-1 bg-transparent border-b border-slate-200 dark:border-slate-600 focus:outline-none" value="${subtask.text}"><button class="delete-subtask-btn text-red-500">&times;</button>`;
                    elements.modalSubtasks.appendChild(subtaskEl);
                });
            }

            elements.modalCategories.innerHTML = Object.keys(CATEGORIES).map(catKey => `<button data-category="${catKey}" class="px-3 py-1 text-sm rounded-full border-2 transition-smooth ${task.category === catKey ? `border-[${CATEGORIES[catKey].color}] bg-[${CATEGORIES[catKey].color}]/20` : 'border-transparent hover:bg-slate-200 dark:hover:bg-slate-700'}">${CATEGORIES[catKey].label}</button>`).join('');
            elements.modalIcons.innerHTML = ICONS.map(icon => `<button data-icon="${icon}" class="p-2 rounded-full transition-smooth ${task.icon === icon ? 'bg-indigo-100 dark:bg-indigo-900' : 'hover:bg-slate-200 dark:hover:bg-slate-700'}">${icon}</button>`).join('');
            const dayOfWeek = new Date(key.split('_')[0]).getDay();
            const hour = key.split('_')[1];
            const recurringKey = `recurring_${dayOfWeek}_${hour}`;
            elements.modalRecurring.checked = getTask(recurringKey).recurring || false;
            openModal(elements.taskModal, elements.taskModalContainer);
        };
        
        const setupNotifications = () => {
            if (!('Notification' in window)) {
                elements.enableNotificationsBtn.textContent = 'Navegador não suporta';
                elements.enableNotificationsBtn.disabled = true;
                return;
            }
            if (Notification.permission === 'granted') {
                elements.enableNotificationsBtn.textContent = 'Lembretes Ativados';
                elements.enableNotificationsBtn.disabled = true;
                if (state.notificationInterval) clearInterval(state.notificationInterval);
                state.notificationInterval = setInterval(() => {
                    const now = new Date();
                    Object.keys(state.tasks).forEach(key => {
                        const task = state.tasks[key];
                        if (task.reminder && task.reminder !== 'none') {
                            const [dateStr, timeStr] = key.split('_');
                            const taskDate = new Date(`${dateStr}T${timeStr}`);
                            const notificationTime = new Date(taskDate.getTime() - parseInt(task.reminder) * 60000);
                            if (notificationTime.getFullYear() === now.getFullYear() &&
                                notificationTime.getMonth() === now.getMonth() &&
                                notificationTime.getDate() === now.getDate() &&
                                notificationTime.getHours() === now.getHours() &&
                                notificationTime.getMinutes() === now.getMinutes()) {
                                
                                new Notification('Lembrete de Tarefa!', { body: `${task.icon || ''} ${task.text}`, icon: './icons/icon-192x192.png' });
                            }
                        }
                    });
                }, 60000); // Roda a cada minuto
            } else if (Notification.permission !== 'denied') {
                elements.enableNotificationsBtn.textContent = 'Ativar Lembretes';
                elements.enableNotificationsBtn.disabled = false;
            } else {
                elements.enableNotificationsBtn.textContent = 'Permissão Negada';
                elements.enableNotificationsBtn.disabled = true;
            }
        };

        const init = () => {
            loadData();
            
            elements.prevBtn.addEventListener('click', () => {
                if (state.currentView === 'week') state.currentDate.setDate(state.currentDate.getDate() - 7);
                else state.currentDate.setMonth(state.currentDate.getMonth() - 1);
                render();
            });
            elements.nextBtn.addEventListener('click', () => {
                if (state.currentView === 'week') state.currentDate.setDate(state.currentDate.getDate() + 7);
                else state.currentDate.setMonth(state.currentDate.getMonth() + 1);
                render();
            });
            elements.toggleViewBtn.addEventListener('click', () => {
                state.currentView = state.currentView === 'week' ? 'month' : 'week';
                render();
            });
            elements.compactViewToggle.addEventListener('click', () => {
                state.settings.compactView = !state.settings.compactView;
                saveData();
                render();
            });
            elements.focusModeToggle.addEventListener('click', () => {
                state.settings.focusMode = !state.settings.focusMode;
                saveData();
                render();
            });
            elements.weeklyView.addEventListener('click', e => {
                const taskContainer = e.target.closest('.task-container');
                if (!taskContainer) return;
                const key = taskContainer.dataset.key;
                if (e.target.closest('.checkbox-custom')) {
                     updateTask(key, { completed: !getTask(key).completed });
                } else if (e.target.closest('.star-icon')) {
                    updateTask(key, { highlighted: !getTask(key).highlighted });
                } else {
                    openTaskModal(key);
                }
            });
            
            let draggedKey = null;
            elements.weeklyView.addEventListener('dragstart', e => {
                if (e.target.classList.contains('task-container')) {
                    draggedKey = e.target.dataset.key;
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                }
            });
            elements.weeklyView.addEventListener('dragover', e => {
                e.preventDefault();
                const targetSlot = e.target.closest('.task-slot');
                if (targetSlot) {
                    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                    targetSlot.classList.add('drag-over');
                }
            });
            elements.weeklyView.addEventListener('dragleave', e => {
                const targetSlot = e.target.closest('.task-slot');
                if (targetSlot) {
                    targetSlot.classList.remove('drag-over');
                }
            });
            elements.weeklyView.addEventListener('drop', e => {
                e.preventDefault();
                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                const targetSlot = e.target.closest('.task-slot');
                if (targetSlot && draggedKey) {
                    const targetKey = targetSlot.dataset.key;
                    if (draggedKey !== targetKey) {
                        const draggedTaskData = { ...getTask(draggedKey) };
                        const targetTaskData = { ...getTask(targetKey) };
                        if (Object.keys(targetTaskData).length > 0) {
                            updateTask(draggedKey, targetTaskData);
                        } else {
                            deleteTask(draggedKey);
                        }
                        updateTask(targetKey, draggedTaskData);
                    }
                }
                draggedKey = null;
            });
            elements.weeklyView.addEventListener('dragend', e => {
                if (e.target.classList.contains('task-container')) {
                    e.target.classList.remove('dragging');
                }
            });

            elements.modalSave.addEventListener('click', () => {
                const subtasks = [];
                elements.modalSubtasks.querySelectorAll('div').forEach(el => {
                    const textInput = el.querySelector('.subtask-text');
                    if (textInput.value) {
                         subtasks.push({
                            text: textInput.value,
                            completed: el.querySelector('.subtask-checkbox').checked
                        });
                    }
                });
                const taskData = {
                    text: elements.modalTextarea.value,
                    notes: elements.modalNotes.value,
                    subtasks: subtasks,
                    category: document.querySelector('#modal-categories button.border-2:not(.border-transparent)')?.dataset.category,
                    icon: document.querySelector('#modal-icons button.bg-indigo-100')?.dataset.icon,
                    reminder: elements.modalReminder.value === 'none' ? null : elements.modalReminder.value
                };
                updateTask(state.activeModalKey, taskData);
                const dayOfWeek = new Date(state.activeModalKey.split('_')[0]).getDay();
                const hour = state.activeModalKey.split('_')[1];
                const recurringKey = `recurring_${dayOfWeek}_${hour}`;
                if (elements.modalRecurring.checked) updateTask(recurringKey, { ...getTask(state.activeModalKey), recurring: true });
                else deleteTask(recurringKey);
                closeModal(elements.taskModal, elements.taskModalContainer);
            });
            elements.modalDelete.addEventListener('click', () => {
                if (confirm('Tem certeza que deseja excluir esta tarefa e sua recorrência?')) {
                    const dayOfWeek = new Date(state.activeModalKey.split('_')[0]).getDay();
                    const hour = state.activeModalKey.split('_')[1];
                    deleteTask(state.activeModalKey);
                    deleteTask(`recurring_${dayOfWeek}_${hour}`);
                    closeModal(elements.taskModal, elements.taskModalContainer);
                }
            });
            elements.modalCancel.addEventListener('click', () => closeModal(elements.taskModal, elements.taskModalContainer));
            elements.taskModal.addEventListener('click', e => {
                const categoryButton = e.target.closest('[data-category]');
                const iconButton = e.target.closest('[data-icon]');
                if (categoryButton) {
                    document.querySelectorAll('#modal-categories button').forEach(btn => {
                        const cat = btn.dataset.category;
                        btn.classList.remove(`border-[${CATEGORIES[cat].color}]`, `bg-[${CATEGORIES[cat].color}]/20`);
                        btn.classList.add('border-transparent');
                    });
                    const cat = categoryButton.dataset.category;
                    categoryButton.classList.add(`border-[${CATEGORIES[cat].color}]`, `bg-[${CATEGORIES[cat].color}]/20`);
                    categoryButton.classList.remove('border-transparent');
                }
                if (iconButton) {
                    document.querySelectorAll('#modal-icons button').forEach(btn => btn.classList.remove('bg-indigo-100', 'dark:bg-indigo-900'));
                    iconButton.classList.add('bg-indigo-100', 'dark:bg-indigo-900');
                    elements.modalIconDisplay.textContent = iconButton.dataset.icon;
                }
            });
            elements.settingsBtn.addEventListener('click', () => {
                elements.themeSelector.value = state.settings.theme;
                renderGoalsInSettings();
                renderBirthdaysInSettings();
                openModal(elements.settingsModal, elements.settingsModalContainer);
            });
            elements.settingsClose.addEventListener('click', () => {
                saveData();
                render();
                closeModal(elements.settingsModal, elements.settingsModalContainer);
            });
            elements.addGoalBtn.addEventListener('click', () => {
                state.settings.goals.push({ id: `goal_${Date.now()}`, category: 'work', hours: 1, enabled: true });
                renderGoalsInSettings();
            });
            elements.goalsList.addEventListener('change', e => {
                const id = e.target.dataset.id;
                const goal = state.settings.goals.find(g => g.id === id);
                if (!goal) return;
                if (e.target.classList.contains('goal-category-select')) goal.category = e.target.value;
                if (e.target.classList.contains('goal-hours-input')) goal.hours = Number(e.target.value) || 1;
            });
             elements.goalsList.addEventListener('click', e => {
                if (e.target.closest('.delete-goal-btn')) {
                    const id = e.target.closest('.delete-goal-btn').dataset.id;
                    state.settings.goals = state.settings.goals.filter(g => g.id !== id);
                    renderGoalsInSettings();
                }
            });
            elements.addBirthdayBtn.addEventListener('click', () => {
                state.settings.birthdays.push({ id: `bday_${Date.now()}`, name: '', date: '' });
                renderBirthdaysInSettings();
            });
            elements.birthdaysList.addEventListener('input', e => {
                 const id = e.target.dataset.id;
                 const bday = state.settings.birthdays.find(b => b.id === id);
                 if (!bday) return;
                 if (e.target.classList.contains('birthday-name-input')) bday.name = e.target.value;
                 if (e.target.classList.contains('birthday-date-input')) bday.date = e.target.value;
            });
            elements.birthdaysList.addEventListener('click', e => {
                if (e.target.closest('.delete-birthday-btn')) {
                    const id = e.target.closest('.delete-birthday-btn').dataset.id;
                    state.settings.birthdays = state.settings.birthdays.filter(b => b.id !== id);
                    renderBirthdaysInSettings();
                }
            });
            elements.themeSelector.addEventListener('change', e => {
                state.settings.theme = e.target.value;
                saveData();
                render();
            });
            elements.reportsBtn.addEventListener('click', () => {
                renderReports();
                openModal(elements.reportsModal, elements.reportsModalContainer);
            });
            elements.reportsClose.addEventListener('click', () => closeModal(elements.reportsModal, elements.reportsModalContainer));
            elements.addSubtaskBtn.addEventListener('click', () => {
                const subtaskEl = document.createElement('div');
                subtaskEl.className = 'flex items-center space-x-2';
                subtaskEl.innerHTML = `<input type="checkbox" class="subtask-checkbox rounded text-[rgb(var(--accent))]"><input type="text" class="subtask-text flex-1 bg-transparent border-b border-slate-200 dark:border-slate-600 focus:outline-none" placeholder="Nova sub-tarefa"><button class="delete-subtask-btn text-red-500">&times;</button>`;
                elements.modalSubtasks.appendChild(subtaskEl);
            });
            elements.modalSubtasks.addEventListener('click', e => {
                if (e.target.classList.contains('delete-subtask-btn')) {
                    e.target.parentElement.remove();
                }
            });
            
            elements.enableNotificationsBtn.addEventListener('click', () => {
                if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                    Notification.requestPermission().then(permission => setupNotifications());
                }
            });

            setupNotifications();
            render();
        };
        
        init();
    });
    </script>
</body>
</html>
